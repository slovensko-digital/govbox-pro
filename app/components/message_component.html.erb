<%= tag.turbo_frame id: dom_id(@message), class: "flex flex-col justify-stretch items-stretch rounded-md bg-white border border-gray-200" do %>
  <div class="flex justify-between items-start gap-4 px-6 pt-6 pb-4 border-b border-gray-200">
    <div class="flex flex-col gap-2">
      <dl class="flex flex-col gap-2 text-gray-90 text-sm leading-6">
        <%= render MessageHeaderSectionComponent.new("Predmet:", @message.title) %>
        <%= render MessageHeaderSectionComponent.new("Odosielateľ:", @message.sender_name || "Neznámy") %>
        <%= render MessageHeaderSectionComponent.new("Adresát:", @message.recipient_name || "Neznámy") %>
      </dl>
      <%= render MessageStateComponent.new(message: @message, classes: "md:hidden") %>
    </div>
    <div class="flex flex-col items-end gap-2">
      <%= render MessageOptionsComponent.new(message: @message, mode: @mode) %>
      <%= render MessageStateComponent.new(message: @message, classes: "hidden md:flex") %>
    </div>
  </div>
  <div class="flex flex-col justify-stretch items-start relative gap-4 p-6 border-t-0 border-r-0 border-b border-l-0 border-gray-200">
    <div class="w-full">
      <%= tag.iframe class: "relative border-none overflow-hidden h-full w-full", srcdoc: @message.html_visualization, onload: "(
            function(iframe) {
              iframe.contentWindow.document.body.style['height'] = 'unset';
              iframe.contentWindow.document.body.style['min-height'] = 'unset';

              iframe.parentElement.style.height = iframe.contentWindow.document.body.scrollHeight + 20 + 'px';
            }
            (this)
          )" %>
    </div>

    <% if @message.form && @message.form.nested_message_objects.count > 1 %>
      <div class="flex flex-col justify-stretch items-stretch divide-y relative px-4 bg-white border border-gray-200 w-full">
        <% @message.form.nested_message_objects.each do |message_attachment| %>
          <!-- TODO lepsia podmienka (ma sa zobrazit vsetko okrem formulara) -->
          <% unless message_attachment.xml? %>
            <div class="flex justify-between items-center p-2 overflow-clip">
              <%= link_to message_message_object_nested_message_object_path(@message, @message.form, message_attachment), data: { turbo_frame: "_top" }, class: "flex justify-start items-center gap-4 overflow-clip" do %>
                <div class="flex flex-col justify-start items-start overflow-clip">
                  <div class="flex justify-start items-start gap-4 w-full">
                    <span class="truncate text-base font-semibold text-left text-gray-900"><%= MessageObjectHelper.displayable_name(message_attachment) %></span>
                  </div>
                  <span class="text-sm text-left text-gray-600">
                    <%= "#{number_to_human_size(message_attachment.content.size)}" %>
                  </span>
                </div>
              <% end %>
              <div class="flex justify-end items-center gap-4">
                <%= link_to message_message_object_nested_message_object_path(@message, @message.form, message_attachment), data: { turbo_frame: "_top" }, class: "flex justify-end items-center md:px-3.5 md:py-2.5 md:rounded-md md:bg-white md:border md:border-gray-300" do %>
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" class="  w-5 h-5 " preserveAspectRatio="xMidYMid meet">
                    <path d="M6.64661 10.3535L9.6465 13.3534C9.64652 13.3534 9.64654 13.3534 9.64655 13.3534C9.74031 13.4471 9.86744 13.4998 10 13.4998C10.1326 13.4998 10.2597 13.4471 10.3534 13.3534C10.3535 13.3534 10.3535 13.3534 10.3535 13.3534L13.3534 10.3534L13.3596 10.3473L13.3596 10.3474C13.4074 10.3012 13.4455 10.2461 13.4717 10.1851C13.4979 10.1241 13.5117 10.0584 13.5123 9.99206C13.5128 9.92567 13.5002 9.85983 13.4751 9.79838C13.4499 9.73693 13.4128 9.68111 13.3658 9.63416C13.3189 9.58721 13.2631 9.55009 13.2016 9.52495C13.1402 9.4998 13.0743 9.48715 13.0079 9.48773C12.9416 9.48831 12.8759 9.5021 12.8149 9.5283C12.7539 9.55451 12.6988 9.5926 12.6526 9.64036L12.6466 9.64661L12.6466 9.64655L11.3536 10.9396L10.5 11.7931V10.586V3C10.5 2.86739 10.4473 2.74021 10.3536 2.64645C10.2598 2.55268 10.1326 2.5 10 2.5C9.86739 2.5 9.74021 2.55268 9.64645 2.64645C9.55268 2.74021 9.5 2.86739 9.5 3V10.586V11.7931L8.64645 10.9396L7.3535 9.64661C7.35348 9.64659 7.35346 9.64657 7.35345 9.64655C7.25969 9.55285 7.13256 9.50021 7 9.50021C6.86747 9.50021 6.74036 9.55283 6.64661 9.6465C6.64657 9.64654 6.64654 9.64657 6.6465 9.64661M6.64661 10.3535L6.293 10.707C6.10553 10.5195 6.00021 10.2652 6.00021 10C6.00021 9.73484 6.10553 9.48053 6.293 9.293L6.6465 9.64661M6.64661 10.3535C6.64659 10.3535 6.64657 10.3535 6.64655 10.3534M6.64661 10.3535L6.64655 10.3534M6.6465 9.64661C6.55283 9.74036 6.50021 9.86747 6.50021 10C6.50021 10.1326 6.55285 10.2597 6.64655 10.3534M6.6465 9.64661L6.64655 10.3534M3.5 17C3.5 16.8674 3.55268 16.7402 3.64645 16.6464C3.74021 16.5527 3.86739 16.5 4 16.5H16C16.1326 16.5 16.2598 16.5527 16.3536 16.6464C16.4473 16.7402 16.5 16.8674 16.5 17C16.5 17.1326 16.4473 17.2598 16.3536 17.3536C16.2598 17.4473 16.1326 17.5 16 17.5H4C3.86739 17.5 3.74021 17.4473 3.64645 17.3536C3.55268 17.2598 3.5 17.1326 3.5 17Z" fill="#111827" stroke="#111827"></path>
                  </svg>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if @message.attachments.any? %>
    <div class="flex justify-start items-center gap-2 px-6 py-4 bg-white border-t-0 border-r-0 border-b border-l-0 border-gray-200">
      <div>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="  w-6 h-6 relative" preserveAspectRatio="xMidYMid meet">
          <path d="M15.1715 6.99998L8.58553 13.586C8.39451 13.7705 8.24215 13.9912 8.13733 14.2352C8.03251 14.4792 7.97734 14.7416 7.97503 15.0072C7.97272 15.2727 8.02333 15.5361 8.12389 15.7819C8.22445 16.0277 8.37296 16.251 8.56074 16.4388C8.74853 16.6266 8.97183 16.7751 9.21762 16.8756C9.46342 16.9762 9.72678 17.0268 9.99233 17.0245C10.2579 17.0222 10.5203 16.967 10.7643 16.8622C11.0083 16.7574 11.229 16.605 11.4135 16.414L17.8275 9.82798C18.5562 9.07357 18.9593 8.06316 18.9502 7.01438C18.9411 5.96559 18.5204 4.96234 17.7788 4.22071C17.0372 3.47907 16.0339 3.0584 14.9851 3.04928C13.9363 3.04017 12.9259 3.44335 12.1715 4.17198L5.75653 10.757C4.63122 11.8823 3.99902 13.4085 3.99902 15C3.99902 16.5914 4.63122 18.1177 5.75653 19.243C6.88184 20.3683 8.4081 21.0005 9.99953 21.0005C11.591 21.0005 13.1172 20.3683 14.2425 19.243L20.4995 13" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </div>
      <p class="grow text-base text-left text-gray-900">
        Správa obsahuje <span class="font-semibold"><%= t('message_object', count: @message.attachments.count, locale: :sk) %></span>
      </p>
    </div>

    <div class="flex flex-col justify-stretch items-stretch divide-y px-4 bg-white border-t-0 border-r-0 border-b border-l-0 border-gray-200">
      <%= render MessageAttachmentComponent.with_collection(@message.attachments) %>
    </div>
  <% end %>

  <% if @mode == :thread_view %>
    <% if @message.can_be_authorized? %>
      <%= form_with(url: authorize_delivery_notification_message_path(@message), method: :post, local: true, class: 'flex p-6 border-b border-gray-200') do |form| %>
        <%= form.submit "Prevziať správu", data: { turbo_frame: "_top", turbo_confirm: 'Naozaj chcete prevziať správu?' }, class: "flex-grow-0 flex-shrink-0 px-3.5 py-2.5 rounded-md bg-blue-600 text-base font-medium text-left text-white" %>
      <% end %>
    <% elsif @message.replyable? %>
      <div class="flex p-6 border-b border-gray-200">
        <%= button_to message_drafts_path, method: :post, params: { original_message_id: @message.id }, data: { turbo: 'false' }, class: "text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-3.5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" do %>
          Odpovedať
        <% end %>
      </div>
    <% end %>
  <% end %>
<% end %>
