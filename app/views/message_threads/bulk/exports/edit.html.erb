<div class="p-4">
  <div class="overflow-hidden bg-white sm:rounded-lg sm:shadow">
    <div class="border-b border-gray-200 bg-white px-4 py-5 sm:px-6">
      <h3 class="text-base font-semibold leading-6 text-gray-900">Hromadný export</h3>
    </div>

    <div class="flow-root m-6">
      <%= form_for @export, url: message_threads_bulk_export_path(@export), html: { id: 'export-form' }, method: :put do %>
        <div>
          <h3 class="text-base font-semibold text-gray-900">Nastavenie exportu</h3>
        </div>

        <div class="py-6">
          <div class="flex items-center gap-x-3 pd-3">
            <%= check_box_tag "export[settings][summary]", "1", @export.settings["summary"], class: "h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 cursor-pointer" %>
            <%= label_tag "export[settings][summary]", "Exportovať sumár", class: "select-none text-sm/6 text-gray-900 cursor-pointer" %>
          </div>

          <div class="flex items-center gap-x-3 py-3">
            <%= check_box_tag "export[settings][messages]", "1", @export.settings["messages"], class: "h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 cursor-pointer", onclick: "this.form.requestSubmit()" %>
            <%= label_tag "export[settings][messages]", "Exportovať správy", class: "select-none text-sm/6 text-gray-900 cursor-pointer" %>
          </div>
          <div style="<%= @export.settings['messages'] ? '' : 'display: none;' %>">
            <p class="mt-1 text-sm text-gray-500">Nastavte ako budú exportované jednotlivé typy správ.</p>

            <div class="mt-2">
              <details class="group">
                <summary class="text-sm cursor-pointer select-none text-gray-500 hover:text-gray-800">Dostupné premenné pre šablónu</summary>
                <div class="mt-2 space-y-1 text-xs text-gray-500 leading-5">
                  <code>{{ schranka.export_nazov }}</code> – upraviteľný názov schránky pre export<br>
                  <code>{{ schranka.oficialny_nazov }}</code> – oficiálny názov schránky<br>
                  <code>{{ schranka.nazov }}</code> – pôvodný názov schránky bez úprav<br>
                  <code>{{ schranka.dic }}</code> – DIČ schránky<br>
                  <code>{{ vlakno.id }}</code> – identifikátor vlákna<br>
                  <code>{{ vlakno.obdobie }}</code> – obdobie vlákna (napr. 2024-01)<br>
                  <code>{{ vlakno.formular }}</code> – typ formulára s verziou (napr. DPHv20)<br>
                  <code>{{ vlakno.formular_bez_verzie }}</code> – typ formulára bez verzie (napr. DPH)<br>
                  <code>{{ vlakno.datum_podania }}</code> – dátum podania<br>
                  <code>{{ sprava.id }}</code> – identifikátor správy<br>
                  <code>{{ subor.nazov }}</code> – názov súboru (napr. priloha.pdf)
                </div>
              </details>
            </div>

            <div class="space-y-4 py-6 px-6">
              <div class="flex items-center gap-x-3">
                <%= check_box_tag "export[settings][pdf]", "1", @export.settings["pdf"], class: "h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 cursor-pointer" %>
                <%= label_tag "export[settings][pdf]", "Exportovať aj PDF", class: "select-none text-sm/6 text-gray-900 cursor-pointer" %>
              </div>

              <table class="min-w-full">
                <tbody>
                <tr class="border-t border-gray-200">
                  <td colspan="3" class="border-t border-gray-200 bg-gray-50 py-2 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-3">Všeobecné nastavenie</td>
                </tr>
                <tr class="border-t border-gray-200">
                  <td class="py-2 pr-3"><%= check_box_tag "export[settings][default]", "1", @export.settings['default'], class: "h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 cursor-pointer" %></td>
                  <td class="text-sm">všetky správy</td>
                  <td class="whitespace-nowrap w-full py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-3"><%= text_field_tag "export[settings][templates][default]", @export.settings.dig('templates', 'default'), class: "block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" %></td>
                </tr>
                <tr>
                  <td colspan="3" class="border-t border-gray-200 bg-gray-50 py-2 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-3">Podľa typu formulára</td>
                </tr>
                <% @message_forms.each do |message_form| %>
                  <tr class="border-t border-gray-200">
                    <td><%= check_box_tag "export[settings][by_form][#{message_form}]", "1", @export.settings.dig('by_form', message_form), class: "h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 cursor-pointer" %></td>
                    <td class="text-sm"><%= message_form %></td>
                    <td class="whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-3">
                      <%= text_field_tag "export[settings][templates][#{message_form}]", @export.settings.dig('templates', message_form), placeholder: 'nastavenie ako pre všetky správy', class: "block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" %>
                    </td>
                  </tr>
                <% end %>

                <tr class="border-t border-gray-200">
                  <td colspan="3" class="bg-gray-50 py-2 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-3">Podľa typu správy</td>
                </tr>
                <% @message_types.each do |message_type| %>
                  <tr class="border-t border-gray-200">
                    <td><%= check_box_tag "export[settings][by_type][#{message_type}]", "1", @export.settings.dig('by_type', message_type), class: "h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-600 cursor-pointer" %></td>
                    <td class="text-sm"><%= message_type %></td>
                    <td class="whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-3">
                      <%= text_field_tag "export[settings][templates][#{message_type}]", @export.settings.dig('templates', message_type), placeholder: 'nastavenie ako pre všetky správy', class: "block w-full rounded-md bg-white px-3 py-1.5 text-base text-gray-900 outline outline-1 -outline-offset-1 outline-gray-300 placeholder:text-gray-400 focus:outline focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 sm:text-sm/6" %>
                    </td>
                  </tr>
                <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      <% end %>

      <div class="flex items-center gap-x-4 mb-6">
        <%= button_tag "Uložiť nastavenia", class: "rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50", onclick: "document.getElementById('export-form').requestSubmit()" %>

        <%= form_for @export, url: message_threads_bulk_export_start_path(@export), method: :post do |f| %>
            <%= f.submit "Exportovať", class: "rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500", data: { turbo_confirm: "Chcete vytvoriť export?" } %>
        <% end %>
      </div>

      <div class="border-b border-gray-200 bg-white py-5">
        <h3 class="text-base font-semibold text-gray-900">Náhľad exportu</h3>
      </div>

      <table class="min-w-full divide-y divide-gray-300">
        <thead>
        <tr>
          <th scope="col" class="whitespace-nowrap py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Schránka</th>
          <th scope="col" class="whitespace-nowrap px-2 py-3.5 text-left text-sm font-semibold text-gray-900">Názov</th>
          <th scope="col" class="whitespace-nowrap px-2 py-3.5 text-left text-sm font-semibold text-gray-900">Typ</th>
          <th scope="col" class="whitespace-nowrap px-2 py-3.5 text-left text-sm font-semibold text-gray-900">Súbor</th>
          <th scope="col" class="relative whitespace-nowrap py-3.5 pl-3 pr-4 sm:pr-0">
            <span class="sr-only">Edit</span>
          </th>
        </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          <% if @export.settings.dig("summary") %>
            <tr>
              <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm text-gray-500 sm:pl-0">-</td>
              <td class="px-2 py-2 text-sm font-medium text-gray-900">Sumár</td>
              <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-900">-</td>
              <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">sumar.xlsx</td>
            </tr>
          <% end %>

          <% if @export.settings.dig("messages") %>
            <% @message_threads.each do |message_thread| %>
              <tr>
                <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm text-gray-500 sm:pl-0"><%= message_thread.box.short_name %></td>
                <td class="px-2 py-2 text-sm font-medium text-gray-900"><%= message_thread.title %>
                  <div class="flex flex-wrap items-center gap-1">
                    <% message_thread.message_threads_tags.only_visible_tags.each do |tag| %>
                      <%= render Common::TagComponent.new(tag.tag) %>
                    <% end %>
                  </div>
                </td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-900"></td>
                <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500"></td>
              </tr>
              <% message_thread.messages.sort_by(&:delivered_at).each do |message| %>
                <tr>
                  <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm text-gray-500 sm:pl-0"></td>
                  <td class="px-2 py-2 text-sm font-medium text-gray-900">
                    <span class="text-gray-500">&#10551;</span> <%= message.title %></td>
                  <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-900"><%= message.message_type || '&mdash;'.html_safe %></td>
                  <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500"></td>
                </tr>
                <% message.objects.each do |message_object| %>
                  <tr>
                    <td class="whitespace-nowrap py-2 pl-4 pr-3 text-sm text-gray-500 sm:pl-0"></td>
                    <td class="px-2 py-2 text-sm font-medium text-gray-900"> &nbsp;&nbsp;<span class="text-gray-500">&#10551;</span> <%= message_object.name %>
                    </td>
                    <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-900"></td>
                    <td class="whitespace-nowrap px-2 py-2 text-sm text-gray-500">
                        <%=
                          filepath = @export.export_object_filepath(message_object)
                          filepath.present? ? content_tag(:code, filepath) : "&mdash;".html_safe
                        %>
                    </td>
                  </tr>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
